<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title></title>

    <link href="css/StyleDefult.css" rel="stylesheet" type="text/css" />
    <link href="css/bootstrap.min.css" rel="stylesheet" />
    <link href="vendors/bootstrap-select/bootstrap-select.min.css" rel="stylesheet" />

    <script src="scripts/jquery-3.3.1.js"></script>
    <script src="scripts/bootstrap.min.js"></script>
    <script src="vendors/bootstrap-select/bootstrap-select.min.js"></script>

    <script type="text/javascript" src="cordova.js"></script>
    <script src="scripts/database.js"></script>
    
    <script type="text/javascript">
        var id = 0;
        var secilenKisi = 0;
        var secilenIsim = "";
        var b7Degeri = 0;
        var b3Degeri = 0; // Yaş
        var b4Degeri = 0; // Cinsiyet
        var b5Degeri = 0; // Eğitim

        document.addEventListener("deviceready", onDeviceReady, false);

        function onDeviceReady() {
            id = getUrlVars()["id"];
            console.log("Device ready! InterviewID:", window.localStorage["InterviewID"]);
            
            var checkDB = setInterval(function() {
                if (typeof db !== 'undefined' && db !== null) {
                    clearInterval(checkDB);
                    LoadData();
                }
            }, 100);
        }

        window.onload = function () {
            id = getUrlVars()["id"];
        };

        function LoadData() {
            console.log("LoadData çağrıldı");
            db.transaction(function (tx) {
                var sqlQuery = "SELECT B3_1_1, B3_2_1, B3_3_1, B3_4_1, B3_5_1, B3_6_1, B3_7_1, B3_8_1, B3_9_1, B3_10_1, B3_11_1, B3_12_1, B3_13_1, B3_14_1, B3_15_1, B3_16_1, B3_17_1, B3_18_1, B3_19_1, B3_20_1, B4_1, B4_2, B4_3, B4_4, B4_5, B4_6, B4_7, B4_8, B4_9, B4_10, B4_11, B4_12, B4_13, B4_14, B4_15, B4_16, B4_17, B4_18, B4_19, B4_20, B5_1, B5_2, B5_3, B5_4, B5_5, B5_6, B5_7, B5_8, B5_9, B5_10, B5_11, B5_12, B5_13, B5_14, B5_15, B5_16, B5_17, B5_18, B5_19, B5_20, B7_1, B7_2, B7_3, B7_4, B7_5, B7_6, B7_7, B7_8, B7_9, B7_10, B7_11, B7_12, B7_13, B7_14, B7_15, B7_16, B7_17, B7_18, B7_19, B7_20, B2a_1_1, B2a_2_1, B2a_3_1, B2a_4_1, B2a_5_1, B2a_6_1, B2a_7_1, B2a_8_1, B2a_9_1, B2a_10_1, B2a_11_1, B2a_12_1, B2a_13_1, B2a_14_1, B2a_15_1, B2a_16_1, B2a_17_1, B2a_18_1, B2a_19_1, B2a_20_1, B8, B8e, B101_O, B9 FROM INTERVIEWS WHERE InterviewID=" + window.localStorage["InterviewID"];
                console.log("SQL sorgusu:", sqlQuery);
                
                tx.executeSql(sqlQuery, [], 
                    function (tx, val) {
                        console.log("SQL başarılı, satır sayısı:", val.rows.length);
                        if (val.rows.length > 0) {
                            var row = val.rows.item(0);
                            console.log("Row data:", row);
                            
                            secilenKisi = row.B9 || 1;
                            console.log("Seçilen kişi numarası:", secilenKisi);
                            
                            var isimKolonu = 'B2a_' + secilenKisi + '_1';
                            secilenIsim = row[isimKolonu] || "Kişi " + secilenKisi;
                            $('#secilenKisiIsim').text(secilenIsim);
                            
                            var b7Kolonu = 'B7_' + secilenKisi;
                            b7Degeri = row[b7Kolonu];
                            
                            var b3Kolonu = 'B3_' + secilenKisi + '_1';
                            b3Degeri = row[b3Kolonu] || 0;
                            
                            var b4Kolonu = 'B4_' + secilenKisi;
                            b4Degeri = row[b4Kolonu] || 0;
                            
                            var b5Kolonu = 'B5_' + secilenKisi;
                            b5Degeri = row[b5Kolonu] || 0;
                            
                            console.log("Seçilen kişi:", secilenKisi, "İsim:", secilenIsim, "B7:", b7Degeri, "B3:", b3Degeri, "B4:", b4Degeri, "B5:", b5Degeri);
                        
                        // B7 = 1 (Emekli) ise B8e, diğer durumlarda B8
                        if (b7Degeri == 1) {
                            console.log("Emekli - B8e gösteriliyor");
                            $('#B8Row').hide();
                            $('#B8eRow').show();
                            applyB8eKosullar();
                            if (row.B8e) {
                                $('#B8e').val(row.B8e);
                            }
                        } else if (b7Degeri == 2 || b7Degeri == 3 || b7Degeri == 4) {
                            if (b7Degeri == 2) {
                                console.log("Çalışmıyor - B8 gösteriliyor (3-7 seçenekler)");
                            } else {
                                console.log("Çalışıyor - B8 gösteriliyor");
                            }
                            $('#B8Row').show();
                            $('#B8eRow').hide();
                            applyB8Kosullar();
                            if (row.B8) {
                                $('#B8').val(row.B8);
                            }
                        } else {
                            console.log("B7 değeri tanımsız:", b7Degeri);
                            $('#B8Row').hide();
                            $('#B8eRow').hide();
                        }
                        
                        if (row.B101_O) $('#B101_O').val(row.B101_O);
                    } else {
                        console.log("Hiç satır bulunamadı");
                    }
                },
                function(tx, error) {
                    console.error("SQL hatası:", error.message);
                });
            });
        }

        function applyB8Kosullar() {
            console.log("applyB8Kosullar çağrıldı - B3:", b3Degeri, "B4:", b4Degeri, "B5:", b5Degeri, "B7:", b7Degeri);
            
            // Önce tüm seçenekleri göster
            $('#B8 option').show();
            $('#B8 option').prop('disabled', false);
            
            $('#B8 option').each(function() {
                var item = parseInt($(this).val());
                if (isNaN(item)) return;
                
                var hide = false;
                
                // Kadınsa (B4=2), 5 ve 6 numaralı seçenekler gizlenir
                if (b4Degeri == 2 && (item == 5 || item == 6)) {
                    hide = true;
                    console.log("B4 koşulu - Seçenek", item, "gizlendi");
                }
                
                // 40 yaşından küçükse, 1 ve 2 numaralı seçenekler gizlenir
                if (parseInt(b3Degeri) < 40 && (item == 1 || item == 2)) {
                    hide = true;
                    console.log("B3 koşulu - Seçenek", item, "gizlendi");
                }
                
                // Eğitim seviyesi 3'ten büyükse (lise ve üstü), 17 ve 25 numaralı seçenekler gizlenir
                if (parseInt(b5Degeri) > 3 && (item == 17 || item == 25)) {
                    hide = true;
                    console.log("B5 koşulu - Seçenek", item, "gizlendi");
                }
                
                // B7 = 1 (Emekli): 3 ve üzeri seçenekler gizlenir (sadece 1,2 görünür)
                if (b7Degeri == 1 && item > 2) {
                    hide = true;
                    console.log("B7=1 koşulu - Seçenek", item, "gizlendi");
                }
                
                // B7 = 2 (Çalışmıyor): 1,2 ve 8+ seçenekler gizlenir (sadece 3-7 görünür)
                if (b7Degeri == 2 && (item < 3 || item > 7)) {
                    hide = true;
                    console.log("B7=2 koşulu - Seçenek", item, "gizlendi");
                }
                
                // B7 = 3 (Ücret/Maaş Karşılığı Çalışıyor): 1-7 ve 18+ seçenekler gizlenir (sadece 8-17 görünür)
                if (b7Degeri == 3 && (item < 8 || item > 17)) {
                    hide = true;
                    console.log("B7=3 koşulu - Seçenek", item, "gizlendi");
                }
                
                // B7 = 4 (Kendi İşinde Çalışıyor): 1-17 seçenekler gizlenir (sadece 18+ görünür)
                if (b7Degeri == 4 && item < 18) {
                    hide = true;
                    console.log("B7=4 koşulu - Seçenek", item, "gizlendi");
                }
                
                if (hide) {
                    $(this).hide();
                }
            });
            
            console.log("B8 koşullar uygulandı");
        }
        
        function applyB8eKosullar() {
            console.log("applyB8eKosullar çağrıldı - B5:", b5Degeri);
            
            // Önce tüm seçenekleri göster
            $('#B8e option').show();
            $('#B8e option').prop('disabled', false);
            
            $('#B8e option').each(function() {
                var item = parseInt($(this).val());
                if (isNaN(item)) return;
                
                var hide = false;
                
                // Eğitim seviyesi 3'ten büyükse (lise ve üstü), 17 ve 25 numaralı seçenekler gizlenir
                if (parseInt(b5Degeri) > 3 && (item == 17 || item == 25)) {
                    hide = true;
                    console.log("B5 koşulu - B8e Seçenek", item, "gizlendi");
                }
                
                if (hide) {
                    $(this).hide();
                }
            });
            
            console.log("B8e koşullar uygulandı");
        }

        $(document).ready(function() {
            console.log("Document ready, jQuery var:", typeof $);
            console.log("selectpicker fonksiyonu:", typeof $.fn.selectpicker);
            if (typeof $.fn.selectpicker !== 'undefined') {
                $('.selectpicker').selectpicker();
            }
        });

        function getUrlVars() {
            var vars = [], hash;
            var indexofHash = window.location.href.indexOf('#');
            var hashes;
            if (indexofHash == -1) {
                hashes = window.location.href.slice((window.location.href.indexOf('?')) + 1).split('&');
            } else {
                hashes = window.location.href.slice((window.location.href.indexOf('#')) + 1).split('&');
            }
            for (var i = 0; i < hashes.length; i++) {
                hash = hashes[i].split('=');
                vars.push(hash[0]);
                vars[hash[0]] = hash[1];
            }
            return vars;
        }

        function gecisKontrol() {
            var updateStr = "";
            
            if ($('#B8Row').is(':visible')) {
                var b8Deger = $('#B8').val();
                if (!b8Deger || b8Deger == "") {
                    alert("Lütfen meslek seçiniz!");
                    $('#B8').focus();
                    return;
                }
                updateStr += "B8='" + b8Deger + "'";
            }
            
            if ($('#B8eRow').is(':visible')) {
                var b8eDeger = $('#B8e').val();
                if (!b8eDeger || b8eDeger == "") {
                    alert("Lütfen emekli iken yapılan mesleği seçiniz!");
                    $('#B8e').focus();
                    return;
                }
                if (updateStr != "") updateStr += ",";
                updateStr += "B8e='" + b8eDeger + "'";
            }
            
            var b101 = $('#B101_O').val();
            if (!b101 || b101.trim() == "") {
                alert("Lütfen meslek açıklamasını giriniz!");
                $('#B101_O').focus();
                return;
            }
            if (updateStr != "") updateStr += ",";
            updateStr += "B101_O='" + b101.replace(/'/g, "''") + "'";
            
            myUpdateRedirect("INTERVIEWS", updateStr, " InterviewID=" + window.localStorage["InterviewID"], "SES25S1.html?id=" + window.localStorage["InterviewID"]);
        }

        function goBack() {
            window.history.back();
        }
    </script>

    <style>
        table#QuestionTable {
            width: 100%;
        }
        table#QuestionTable td {
            padding: 10px;
            vertical-align: middle;
        }
        .form-control {
            width: 100%;
        }
        
        /* Disabled option'ları gri ve italik göster */
        select option:disabled {
            color: #999 !important;
            background-color: #f5f5f5 !important;
            font-style: italic;
        }
        
        /* Aktif option'ları koyu renk ve bold göster */
        select option:not(:disabled) {
            color: #000 !important;
            font-weight: bold;
        }
        
        /* Select dropdown'ı daha iyi göster */
        select.form-control {
            font-size: 14px;
            padding: 8px;
            border: 2px solid #007bff;
        }
    </style>
</head>
<body>
    <form id="form1">
        <table border="0" id="QuestionText">
            <tbody>
                <tr>
                    <td>
                        <span id="StepNameTD">B10.</span>
                        <span id="QuestionTextTD">
                            <font face="Calibri" color="#000000" size="2">
                                <b><span id="secilenKisiIsim"></span></b> için meslek bilgileri
                            </font>
                        </span>
                    </td>
                </tr>
            </tbody>
        </table>
        
        <div id="QuestionBuilderPanel">
            <table id="QuestionTable" cellpadding="0" cellspacing="0">
                <tbody>
                    <!-- B8 - Aktif çalışan mesleği -->
                    <tr id="B8Row" style="display:none;">
                        <td class="columnDivider"></td>
                        <td colspan="2">
                            <label for="B8">Mesleği:</label>
                            <select id="B8" name="B8" class="form-control" data-live-search="true">
                                <option value="">Meslek Seçiniz</option>
                                <option value="1">Emekli çalışıyor.</option>
                                <option value="2">Emekli Çalışmıyor</option>
                                <option value="3">İşsiz şuan çalışmıyor-ek geliri yok, yardım alıyor</option>
                                <option value="4">İşsiz Şuan çalışmıyor-düzenli ek geliri var</option>
                                <option value="5">Ev kadını-ek geliri yok, yardım alıyor</option>
                                <option value="6">Ev kadını-düzenli ek geliri var.</option>
                                <option value="7">Öğrenci (gelir getirici bir işi yok)</option>
                                <option value="8">İşçi / hizmetli-parça başı işi olan(düzensiz zaman zaman çalışan)</option>
                                <option value="9">İşçi / hizmetli-düzenli işi olan (özel bir sebep olmadıkça aynı işi yapan)</option>
                                <option value="10">Ustabaşı / kalfa-kendine bağlı işçi çalışan</option>
                                <option value="11">Yönetici olmayan memur / teknik eleman / uzman vs.</option>
                                <option value="12">Yönetici (1-5 çalışanı olan)</option>
                                <option value="13">Yönetici (6-10 çalışanı olan)</option>
                                <option value="14">Yönetici (11-20 çalışanı olan)</option>
                                <option value="15">Yönetici (20'den fazla çalışanı olan)</option>
                                <option value="16">Ordu mensubu (uzman er, astsubay, subay)</option>
                                <option value="17">Ücretli Kıdemli Nitelikli uzman (avukat, doktor, mimar, mühendis, akademisyen vs)</option>
                                <option value="18">Çiftçi (kendi başına / ailesiyle çalışan)</option>
                                <option value="19">Seyyar-kendi işi (freelance dahil), dükkanda hizmet vermiyor</option>
                                <option value="20">Tek başına çalışan, dükkan sahibi, esnaf (ticari taksi sahibi)</option>
                                <option value="21">İşyeri sahibi 1-5 çalışanlı (Ticaret, Tarım, İmalat, Hizmet)</option>
                                <option value="22">İşyeri sahibi 6-10 çalışanlı (Ticaret, Tarım, İmalat, Hizmet)</option>
                                <option value="23">İşyeri sahibi 11-20 çalışanlı (Ticaret, Tarım, İmalat, Hizmet)</option>
                                <option value="24">İşyeri sahibi 20'den fazla çalışanlı (Ticaret, Tarım, İmalat, Hizmet)</option>
                                <option value="25">Serbest nitelikli uzman (Avukat, Mühendis, Mali müşavir, Doktor, Eczacı vs)</option>
                            </select>
                        </td>
                    </tr>
                    
                    <!-- B8e - Emekli mesleği -->
                    <tr id="B8eRow" style="display:none;">
                        <td class="columnDivider"></td>
                        <td colspan="2">
                            <label for="B8e">Emekli olmadan önceki mesleği:</label>
                            <select id="B8e" name="B8e" class="form-control" data-live-search="true">
                                <option value="">Meslek Seçiniz</option>
                                <option value="8">İşçi / hizmetli-parça başı işi olan(düzensiz zaman zaman çalışan)</option>
                                <option value="9">İşçi / hizmetli-düzenli işi olan (özel bir sebep olmadıkça aynı işi yapan)</option>
                                <option value="10">Ustabaşı / kalfa-kendine bağlı işçi çalışan</option>
                                <option value="11">Yönetici olmayan memur / teknik eleman / uzman vs.</option>
                                <option value="12">Yönetici (1-5 çalışanı olan)</option>
                                <option value="13">Yönetici (6-10 çalışanı olan)</option>
                                <option value="14">Yönetici (11-20 çalışanı olan)</option>
                                <option value="15">Yönetici (20'den fazla çalışanı olan)</option>
                                <option value="16">Ordu mensubu (uzman er, astsubay, subay)</option>
                                <option value="17">Ücretli Kıdemli Nitelikli uzman (avukat, doktor, mimar, mühendis, akademisyen vs)</option>
                                <option value="18">Çiftçi (kendi başına / ailesiyle çalışan)</option>
                                <option value="19">Seyyar-kendi işi (freelance dahil), dükkanda hizmet vermiyor</option>
                                <option value="20">Tek başına çalışan, dükkan sahibi, esnaf (ticari taksi sahibi)</option>
                                <option value="21">İşyeri sahibi 1-5 çalışanlı (Ticaret, Tarım, İmalat, Hizmet)</option>
                                <option value="22">İşyeri sahibi 6-10 çalışanlı (Ticaret, Tarım, İmalat, Hizmet)</option>
                                <option value="23">İşyeri sahibi 11-20 çalışanlı (Ticaret, Tarım, İmalat, Hizmet)</option>
                                <option value="24">İşyeri sahibi 20'den fazla çalışanlı (Ticaret, Tarım, İmalat, Hizmet)</option>
                                <option value="25">Serbest nitelikli uzman (Avukat, Mühendis, Mali müşavir, Doktor, Eczacı vs)</option>
                            </select>
                        </td>
                    </tr>
                    
                    <!-- B101_O - Meslek açıklaması -->
                    <tr id="B101Row">
                        <td class="columnDivider"></td>
                        <td colspan="2">
                            <label for="B101_O">Meslek açıklaması:</label>
                            <input type="text" id="B101_O" name="B101_O" class="form-control" placeholder="Meslek açıklamasını giriniz" />
                        </td>
                    </tr>
                    
                    <tr>
                        <td colspan="2">
                            <input type="button" value="Durum Kodla" onclick="javascript: window.location.href = 'ResponseKodu.html';" />
                        </td>
                        <td align="right">
                            <input type="button" id="next" name="next" value="İleri" onclick="gecisKontrol();" />
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </form>
</body>
</html>
